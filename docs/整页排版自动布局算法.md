# 整页排版自动布局算法文档

## 概述

整页排版自动布局算法用于将多个单个标签自动排列到标准尺寸的画布上（如A4、5寸、6寸、7寸等），以便进行打印或印刷。

## 核心功能

1. **自动网格计算**：根据画布尺寸和标签尺寸计算最优的排列方式
2. **行列布局**：从左到右、从上到下自动排列标签
3. **间距控制**：在标签之间预留合理的间距
4. **边距控制**：在画布四周预留边距

## 算法流程

### 1. 输入参数

```
- labelDesigns: LabelDesign[]      // 要排列的标签设计列表
- canvasSize: { width, height }    // 画布尺寸（毫米）
- options: AutoLayoutOptions        // 布局选项
  - spacing: number                 // 标签间距（默认2mm）
  - margins: { top, right, bottom, left }  // 边距（默认5mm）
  - orientation: 'horizontal' | 'vertical'  // 排列方向
```

### 2. 算法步骤

#### 步骤 1：计算可用区域

```typescript
availableWidth = canvasSize.width - margins.left - margins.right
availableHeight = canvasSize.height - margins.top - margins.bottom
```

从画布尺寸中减去边距，得到实际可用的区域。

#### 步骤 2：计算最大行列数

```typescript
maxColumns = floor(availableWidth / (labelWidth + spacing))
maxRows = floor(availableHeight / (labelHeight + spacing))
```

计算在可用区域内最多可以放置多少列和多少行标签。

#### 步骤 3：确定实际行列数

根据排列方向选择列优先或行优先：

- **水平排列（horizontal）**：
  ```typescript
  columns = min(maxColumns, labelDesigns.length)
  rows = ceil(labelDesigns.length / columns)
  ```

- **垂直排列（vertical）**：
  ```typescript
  columns = floor(sqrt(labelDesigns.length * availableWidth / availableHeight))
  rows = ceil(labelDesigns.length / columns)
  ```

#### 步骤 4：计算起始位置（居中放置）

```typescript
totalWidth = columns * labelWidth + (columns - 1) * spacing
totalHeight = rows * labelHeight + (rows - 1) * spacing

startX = margins.left + (availableWidth - totalWidth) / 2
startY = margins.top + (availableHeight - totalHeight) / 2
```

计算标签布局的总宽度和高度，然后计算起始位置以实现居中。

#### 步骤 5：为每个标签分配位置

```typescript
for (index, labelDesign) in labelDesigns:
    row = floor(index / columns)
    col = index % columns
    
    x = startX + col * (labelWidth + spacing)
    y = startY + row * (labelHeight + spacing)
    
    instances.push({
        id: generateId(),
        labelDesign,
        position: { x, y },
        isSelected: false
    })
```

遍历所有标签，根据其在网格中的行列位置计算实际坐标。

## 算法示例

### 示例 1：A4纸张（210×297mm）排列 65×35mm 标签

输入参数：
- 画布尺寸：210×297mm
- 标签尺寸：65×35mm
- 间距：2mm
- 边距：5mm

计算过程：

```
可用区域宽度 = 210 - 5 - 5 = 200mm
可用区域高度 = 297 - 5 - 5 = 287mm

每列占用 = 65 + 2 = 67mm
每行占用 = 35 + 2 = 37mm

最大列数 = floor(200 / 67) = 2列
最大行数 = floor(287 / 37) = 7行

实际可排列标签数 = 2 × 7 = 14个标签

每个标签位置：
标签1: (5 + 33, 5 + 0) = (38, 5)
标签2: (5 + 100, 5 + 0) = (105, 5)
标签3: (5 + 33, 5 + 37) = (38, 42)
...
```

### 示例 2：5寸照片（127×89mm）排列 30×20mm 标签

输入参数：
- 画布尺寸：127×89mm
- 标签尺寸：30×20mm
- 间距：2mm
- 边距：3mm

计算过程：

```
可用区域宽度 = 127 - 3 - 3 = 121mm
可用区域高度 = 89 - 3 - 3 = 83mm

每列占用 = 30 + 2 = 32mm
每行占用 = 20 + 2 = 22mm

最大列数 = floor(121 / 32) = 3列
最大行数 = floor(83 / 22) = 3行

实际可排列标签数 = 3 × 3 = 9个标签
```

## 边界处理

### 最小标签数量

如果标签太大无法放入画布，算法至少保证能放置1个标签：

```typescript
actualColumns = max(1, columns)
actualRows = max(1, rows)
```

### 越界检测

提供辅助函数检测标签是否超出画布范围：

```typescript
function isInstanceInBounds(instance, canvasSize):
    return (
        instance.position.x >= 0 &&
        instance.position.y >= 0 &&
        instance.position.x + labelSize.width <= canvasSize.width &&
        instance.position.y + labelSize.height <= canvasSize.height
    )
```

## 碰撞检测

### 边界矩形

计算标签实例的边界矩形：

```typescript
function getInstanceBounds(instance):
    return {
        x: position.x,
        y: position.y,
        width: labelSize.width,
        height: labelSize.height,
        right: position.x + labelSize.width,
        bottom: position.y + labelSize.height
    }
```

### 碰撞检测

检测两个标签实例是否重叠：

```typescript
function doInstancesCollide(instance1, instance2):
    bounds1 = getInstanceBounds(instance1)
    bounds2 = getInstanceBounds(instance2)
    
    return !(
        bounds1.right <= bounds2.x ||
        bounds2.right <= bounds1.x ||
        bounds1.bottom <= bounds2.y ||
        bounds2.bottom <= bounds1.y
    )
```

使用分离轴定理（SAT）简化版，检查是否在任何轴上有分离。

## 性能优化

### 1. 批量计算

对于大量标签，算法一次性计算所有位置，避免逐个计算的开销。

### 2. 内存管理

只存储必要的布局信息，每个实例只包含：
- ID
- 标签设计引用
- 位置坐标
- 选中状态

### 3. 时间复杂度

- 计算最大行列数：O(1)
- 计算起始位置：O(1)
- 分配位置：O(n)，n为标签数量

总体时间复杂度：O(n)，其中n为标签数量。

## 使用场景

1. **打印标签**：将多个相同的标签排列到一张A4纸上打印
2. **批量印刷**：将不同设计的标签混合排列到印刷纸张上
3. **照片排版**：将多个小标签排列在照片纸上
4. **自定义尺寸**：支持任意尺寸的画布和标签

## 注意事项

1. **尺寸单位**：所有尺寸以毫米（mm）为单位
2. **间距控制**：默认间距2mm，可根据实际需求调整
3. **边距预留**：默认边距5mm，确保打印时不会被裁剪
4. **居中对齐**：标签区域在画布上居中显示，保证美观
5. **缩放显示**：在UI中可能需要缩放显示，但导出时使用原始尺寸

## 未来扩展

1. **智能优化**：根据标签尺寸自动选择最优间距
2. **不规则排版**：支持标签不规则排列
3. **旋转支持**：支持标签旋转90度排列以节省空间
4. **智能方向**：自动选择横向或纵向以获得更多标签
5. **预览优化**：提供实时预览，显示预计能放置的标签数量
