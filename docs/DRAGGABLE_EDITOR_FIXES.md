# 可拖拽编辑器交互问题修复

## 发现的问题

### 1. **画布初始化后不更新** ❌
- **问题**：`DraggableLabelCanvas` 使用 `isInitializedRef` 标记初始化完成，但之后即使 props 变化也不重新初始化
- **影响**：修改商品数据（名称、价格等）后，画布上的文本不会更新
- **修复**：移除 `isInitializedRef` 的限制，让画布能够响应数据变化

### 2. **商品数据变化不反映到画布** ❌
- **问题**：没有监听 `productData` 的变化来更新元素文本
- **影响**：用户在右侧表单修改商品信息后，左侧画布不更新
- **修复**：添加 `useEffect` 监听 `productData` 的各个字段变化，并更新对应元素文本

### 3. **保存/加载位置数据格式不一致** ⚠️
- **问题**：保存时转换为百分比（0-100），加载时通过 `<= 100` 判断是否是百分比
- **影响**：当一个元素恰好在 100 像素位置时会有歧义
- **修复**：改进判断逻辑，使用 `>= 0 && <= 100` 来判断百分比格式

### 4. **依赖数组导致的循环重渲染** ❌
- **问题**：`useEffect` 的依赖数组包含函数对象，导致不必要的重新渲染
- **影响**：性能问题和潜在的无限循环
- **修复**：添加 `eslint-disable-next-line` 注释，并细化依赖项

### 5. **类型定义不一致** ❌
- **问题**：`FontConfig` 在 `types.ts` 和 `FontCustomizer.tsx` 中定义不一致
- **影响**：TypeScript 类型错误
- **修复**：统一类型定义，使用联合类型 `'normal' | 'italic'` 和 `'left' | 'center' | 'right'`

### 6. **位置控制数据流问题** ⚠️
- **问题**：`PositionControl` 更新元素位置时通过 ref 调用，可能导致状态不同步
- **影响**：手动输入位置值时，画布可能不立即更新
- **修复**：改进了位置更新的逻辑，确保数据一致性

## 修复内容

### src/app/draggable-editor/page.tsx
1. ✅ 修复位置监听逻辑，当没有选中元素时清空位置状态
2. ✅ 修复初始化 `useEffect` 的依赖数组
3. ✅ 修复保存逻辑，使用正确的尺寸计算
4. ✅ 添加类型约束（`as const`）

### src/components/editor/DraggableLabelCanvas.tsx
1. ✅ 移除 `isInitializedRef` 的限制
2. ✅ 添加 `productData` 变化监听，自动更新元素文本
3. ✅ 改进保存布局的判断逻辑
4. ✅ 优化依赖数组，避免不必要的重新渲染
5. ✅ 添加辅助函数 `getElementText` 生成元素文本

### src/lib/types.ts
1. ✅ 统一 `FontConfig` 类型定义
2. ✅ 使用联合类型替代通用 `string` 类型

## 测试建议

1. **修改商品信息**：
   - 在右侧表单修改商品名称、价格、品牌等
   - 确认左侧画布上的文本立即更新

2. **拖拽元素**：
   - 点击并拖动元素
   - 确认元素跟随鼠标移动
   - 松开鼠标确认元素位置保持

3. **保存和加载**：
   - 点击"保存标签"
   - 关闭并重新打开"加载设计"
   - 确认位置和内容正确恢复

4. **手动调整位置**：
   - 点击选中元素
   - 在右侧位置控制中输入百分比
   - 确认元素位置正确更新

5. **字体设置**：
   - 选中元素
   - 修改字体大小、颜色等
   - 确认画布立即更新

## 注意事项

1. **位置格式**：保存时使用百分比格式（0-100 之间的数值）
2. **初始化时机**：只在新设计或第一次加载时初始化布局
3. **数据同步**：修改商品数据会立即更新画布文本，但不影响元素位置
4. **性能优化**：使用 `hasChanged` 标记避免不必要的状态更新

